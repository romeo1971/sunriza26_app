# Define a global platform for your project
platform :ios, '15.0'

# CocoaPods analytics sends network stats synchronously affecting flutter build latency.
ENV['COCOAPODS_DISABLE_STATS'] = 'true'

project 'Runner', {
  'Debug' => :debug,
  'Profile' => :release,
  'Release' => :release,
}

def flutter_root
  generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
  unless File.exist?(generated_xcode_build_settings_path)
    raise "#{generated_xcode_build_settings_path} must exist. If you're running pod install manually, make sure flutter pub get is executed first"
  end

  File.foreach(generated_xcode_build_settings_path) do |line|
    matches = line.match(/FLUTTER_ROOT\=(.*)/)
    return matches[1].strip if matches
  end
  raise "FLUTTER_ROOT not found in #{generated_xcode_build_settings_path}. Try deleting Generated.xcconfig, then run flutter pub get"
end

require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)

flutter_ios_podfile_setup

target 'Runner' do
pod 'Firebase/Crashlytics'
  use_frameworks!

  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
  target 'RunnerTests' do
    inherit! :search_paths
  end
end

post_install do |installer|
  installer.pods_project.targets.each do |target|
    flutter_additional_ios_build_settings(target)
    # Unterdrücke Xcode-Warnung: "Create Symlinks to Header Folders will be run during every build"
    # durch Setzen eines Dummy-Outputs für die Script-Phase.
    target.build_phases.each do |phase|
      if phase.is_a?(Xcodeproj::Project::Object::PBXShellScriptBuildPhase) &&
         phase.name == 'Create Symlinks to Header Folders'
        if phase.output_paths.nil? || phase.output_paths.empty?
          phase.output_paths << "$(DERIVED_FILE_DIR)/PodsHeadersSymlinks-#{target.name}"
        end
      end
    end
    # Warnungen in Pod-Targets unterdrücken und Duplicate -lc++ entfernen
    target.build_configurations.each do |config|
      # Alle Pod-Warnungen ausblenden (Swift/ObjC)
      config.build_settings['SWIFT_SUPPRESS_WARNINGS'] = 'YES'
      config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = 'YES'

      # iOS-Deployment-Target aller Pods hart auf 15.0 setzen
      # (sonst setzen viele Pods weiterhin 9.0 und Xcode meckert)
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'

      # Für Release/Profile grundsätzlich dSYMs erzeugen
      if ['Release', 'Profile'].include?(config.name)
        config.build_settings['DEBUG_INFORMATION_FORMAT'] = 'dwarf-with-dsym'
        config.build_settings['GCC_GENERATE_DEBUGGING_SYMBOLS'] = 'YES'
      end

      # Nur für WebRTC-Pod und nur Release/Profile: dSYM erzwingen
      if (target.name.include?('WebRTC')) && (['Release', 'Profile'].include?(config.name))
        config.build_settings['DEBUG_INFORMATION_FORMAT'] = 'dwarf-with-dsym'
      end

      # Duplicate Linker-Flags deduplizieren und -lc++ entfernen
      flags = config.build_settings['OTHER_LDFLAGS']
      if flags.is_a?(Array)
        cleaned = flags.uniq - ['-lc++', 'libc++']
        config.build_settings['OTHER_LDFLAGS'] = cleaned
      elsif flags.is_a?(String)
        parts = flags.split(' ')
        cleaned = parts.uniq - ['-lc++', 'libc++']
        config.build_settings['OTHER_LDFLAGS'] = cleaned.join(' ')
      end
    end
  end

  # Füge eine Build-Phase im App-Target hinzu, die beim Archivieren
  # (Deployment Postprocessing) vorhandene WebRTC dSYMs in den dSYM-Ordner kopiert.
#   installer.aggregate_targets.each do |aggregate_target|
#     next unless aggregate_target.name == 'Pods-Runner'
#     aggregate_target.user_targets.each do |user_target|
#       phase_name = 'Copy WebRTC dSYMs'
#       exists = user_target.build_phases.any? { |p| p.respond_to?(:name) && p.name == phase_name }
#       unless exists
#         phase = user_target.new_shell_script_build_phase(phase_name)
#         phase.shell_script = <<-SCRIPT
# set -e
# SRC="${PODS_ROOT}/WebRTC-SDK/WebRTC.xcframework"
# DST="${DWARF_DSYM_FOLDER_PATH}"

# # 1) Mitgelieferte dSYMs finden (robust, beliebiger Unterordner mit ios-arm64)
# FOUND=0
# while IFS= read -r -d '' DS; do
#   cp -R "$DS" "$DST"
#   FOUND=1
# done < <(find "$SRC" -path "*ios-arm64*" -name "WebRTC*.dSYM" -print0 2>/dev/null)

# if [ "$FOUND" -eq 0 ]; then
#   # 2) Fallback: dSYM aus dem Device‑Slice erzeugen
#   BIN=$(find "$SRC" -path "*ios-arm64*" -name WebRTC -type f | head -n 1)
#   if [ -n "$BIN" ]; then
#     /usr/bin/dsymutil "$BIN" -o "$DST/WebRTC.framework.dSYM" || true
#   fi
# fi
#         SCRIPT
#         # Dependency-Analyse informieren: Input/Output zur Vermeidung der Warnung setzen
#         phase.input_paths ||= []
#         phase.output_paths ||= []
#         phase.input_paths << "$(PODS_ROOT)/WebRTC-SDK/WebRTC.xcframework"
#         phase.output_paths << "$(DWARF_DSYM_FOLDER_PATH)/WebRTC.framework.dSYM"
#         # Nur beim Archivieren ausführen
#         phase.run_only_for_deployment_postprocessing = '0'
#       end
#     end
#   end
end
