rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper Functions (Struppi-System)
    function signedIn() { return request.auth != null; }
    function isOwner(userId) { return signedIn() && request.auth.uid == userId; }
    function isValidFileType() {
      return request.resource.contentType.matches('image/.*') ||
             request.resource.contentType.matches('video/.*') ||
             request.resource.contentType.matches('audio/.*') ||
             request.resource.contentType.matches('text/.*') ||
             request.resource.contentType.matches('application/pdf');
    }
    function isValidFileSize() {
      return request.resource.size < 50 * 1024 * 1024; // 50MB limit
    }

    // Avatar Files (Struppi-System)
    match /avatars/{avatarId}/{allPaths=**} {
      allow read: if true; // Public read
      allow write: if signedIn() && 
                      (
                        // Root-Avatar gehört dem Nutzer
                        (firestore.exists(/databases/(default)/documents/avatars/$(avatarId)) &&
                         firestore.get(/databases/(default)/documents/avatars/$(avatarId)).data.userId == request.auth.uid) ||
                        // ODER Nutzer hat Avatar-Mapping
                        firestore.exists(/databases/(default)/documents/users/$(request.auth.uid)/avatars/$(avatarId))
                      ) &&
                      isValidFileType() && 
                      isValidFileSize();
    }

    // User Profile Images (Struppi-System)
    match /users/{userId}/images/profileImage/{allPaths=**} {
      allow read: if true; // Public read
      allow write, delete: if signedIn() && request.auth.uid == userId;
    }

    // User Uploads (Legacy-Fallback ohne avatarId)
    match /users/{userId}/uploads/{allPaths=**} {
      allow read: if true; // Public read
      allow write, delete: if isOwner(userId) && isValidFileType() && isValidFileSize();
    }

    // Chat Files (Struppi-System)
    match /chats/{chatId}/files/{allPaths=**} {
      allow read, write: if signedIn() && isValidFileType() && isValidFileSize();
    }

    // Legal Pages Files (Struppi-System)
    match /legal_pages/{type}/{allPaths=**} {
      allow read: if true; // Öffentlich lesbar
      allow write: if signedIn() && isValidFileType() && isValidFileSize();
    }

    // Analytics Files (Struppi-System)
    match /analytics/{userId}/{allPaths=**} {
      allow read, write: if isOwner(userId) && isValidFileType() && isValidFileSize();
    }

    // Public Assets (Struppi-System)
    match /public/{allPaths=**} {
      allow read: if true; // Öffentlich lesbar
      allow write: if signedIn() && isValidFileType() && isValidFileSize();
    }
  }
}


