# Marketplace & Payout System - Konzept & Kritik

**Stand:** 03.10.2025  
**Status:** üîç **KONZEPTPHASE - Noch nicht implementiert**

---

## üéØ Dein Konzept

### User-Rollen
1. **K√§ufer** - Kauft Media (Bilder/Videos/Audio)
2. **Verk√§ufer** - Verkauft eigene Media √ºber seinen Avatar
3. **Platform (IHR)** - Vermittelt & wickelt Zahlungen ab

### Zahlungsfluss (Dein Vorschlag)
```
K√§ufer zahlt ‚Üí EUER Stripe ‚Üí Credits f√ºr Verk√§ufer ‚Üí Auszahlung √ºber Stripe
```

---

## ‚ö†Ô∏è KRITISCHE ANALYSE

### ‚ùå Problem 1: Rechtliche Verantwortung
**Dein Plan:**
> "Nutzer kauft von UNS, aber eigentlich verantwortlich ist der verkaufende User"

**Problem:**
- **IHR** seid rechtlich der Verk√§ufer (aus K√§ufer-Sicht)
- **IHR** m√ºsst Rechnungen ausstellen
- **IHR** haftet f√ºr Urheberrechtsverletzungen
- **IHR** m√ºsst MwSt. abf√ºhren
- **IHR** braucht Gewerbeanmeldung pro Land

**Risiko:** üî¥ **SEHR HOCH**

### ‚ùå Problem 2: Steuer-Chaos
**Dein Plan:**
> "Credits werden gutgeschrieben, dann Auszahlung"

**Problem:**
- Credits = Geldersatz = **E-Geld-Lizenz** erforderlich (BaFin!)
- Auszahlungen = Ihr zahlt Einnahmen ‚Üí **IHR** m√ºsst versteuern
- Verk√§ufer m√ºssen dann NOCHMAL versteuern
- **Doppelbesteuerung!**

**Risiko:** üî¥ **SEHR HOCH**

### ‚ùå Problem 3: Stripe ToS Verletzung
**Dein Plan:**
> "User gibt Stripe API Daten ein, wir verbinden"

**Problem:**
- Stripe verbietet **Account-Sharing**
- API Keys weitergeben = **Versto√ü gegen ToS**
- Account-Sperrung droht

**Risiko:** üî¥ **HOCH**

---

## ‚úÖ EMPFOHLENE L√ñSUNG: Stripe Connect

### Was ist Stripe Connect?
Stripe's **offizielle** Marketplace-L√∂sung:
- Verk√§ufer haben EIGENE Stripe Accounts (Connected Accounts)
- Zahlungen gehen DIREKT an Verk√§ufer
- IHR bekommt automatisch eure Provision
- Stripe k√ºmmert sich um Steuern, Rechnungen, Haftung

### Vorteile
‚úÖ **Rechtlich sauber** - Verk√§ufer ist rechtlich Verk√§ufer  
‚úÖ **Steuerlich korrekt** - Jeder versteuert seine Einnahmen  
‚úÖ **Stripe-konform** - Offiziell unterst√ºtzt  
‚úÖ **Keine E-Geld-Lizenz** n√∂tig  
‚úÖ **Automatische Auszahlungen** - Stripe macht das  
‚úÖ **Internationale Skalierung** - Stripe k√ºmmert sich um L√§nder-Regeln

---

## üèóÔ∏è ARCHITEKTUR: Stripe Connect

### User-Profil Erweiterung
```dart
class UserProfile {
  // Verk√§ufer-Daten (optional - nur wenn User verkaufen will)
  final bool isSeller;                    // Verkauft der User?
  final String? stripeConnectAccountId;   // Connected Account ID
  final String? stripeConnectStatus;      // pending, active, restricted
  final bool? payoutsEnabled;             // Auszahlungen aktiviert?
  
  // Business-Daten (optional)
  final String? businessName;             // Firmenname (optional)
  final String? businessEmail;            // Firma E-Mail
  final String? businessPhone;            // Firma Telefon
  final String? businessAddress;          // Firma Adresse
  final String? taxId;                    // Steuernummer/USt-ID
  final String? businessType;             // individual, company
  
  // Existing...
  final String? stripeCustomerId;         // Als K√ÑUFER
  final int credits;
  final int creditsPurchased;
  final int creditsSpent;
}
```

### Zahlungsfluss (Stripe Connect)

#### Option A: Direct Charges (EMPFOHLEN)
```
K√§ufer zahlt 10‚Ç¨ f√ºr Bild
  ‚Üì
Stripe teilt auf:
  ‚Üí 9,50‚Ç¨ gehen DIREKT an Verk√§ufer-Account
  ‚Üí 0,50‚Ç¨ gehen an EUREN Account (Provision)
  ‚Üì
Verk√§ufer bekommt Geld in 2-7 Tagen auf sein Bankkonto
IHR bekommt Provision sofort
```

**Vorteil:** 
- Keine Credits n√∂tig
- Verk√§ufer ist rechtlich Verk√§ufer
- Automatische Auszahlungen
- Steuerlich sauber

#### Option B: Destination Charges
```
K√§ufer zahlt 10‚Ç¨ an EUCH
  ‚Üì
IHR behaltet 0,50‚Ç¨ Provision
IHR transferiert 9,50‚Ç¨ an Verk√§ufer
  ‚Üì
Verk√§ufer bekommt Geld
```

**Nachteil:** IHR seid rechtlich Verk√§ufer (wie dein aktueller Plan)

### ‚úÖ EMPFEHLUNG: Direct Charges

---

## üí∞ PROVISIONS-MODELL

### Beispiel: 20% Platform Fee
```
Verk√§ufer setzt Preis: 10,00 ‚Ç¨
Platform Fee (20%):     2,00 ‚Ç¨
Stripe Fee (~3%):       0,33 ‚Ç¨
  ‚Üì
Verk√§ufer erh√§lt:       7,67 ‚Ç¨
IHR erhaltet:           2,00 ‚Ç¨
Stripe erh√§lt:          0,33 ‚Ç¨
```

### Code (vereinfacht)
```dart
// Media-Kauf mit Stripe Connect
final session = await stripe.checkout.sessions.create({
  'line_items': [{
    'price_data': {
      'unit_amount': 1000, // 10,00 ‚Ç¨
      'currency': 'eur',
    },
    'quantity': 1,
  }],
  'payment_intent_data': {
    'application_fee_amount': 200, // 2,00 ‚Ç¨ f√ºr euch (20%)
    'transfer_data': {
      'destination': sellerStripeAccountId, // Verk√§ufer bekommt Rest
    },
  },
});
```

---

## üîÑ ONBOARDING-FLOW: Verk√§ufer werden

### Schritt 1: "Verk√§ufer werden" Button im Profil
```dart
ElevatedButton(
  onPressed: () => _startSellerOnboarding(),
  child: Text('Jetzt verkaufen & Geld verdienen'),
)
```

### Schritt 2: Stripe Connect Account erstellen
```typescript
// Cloud Function
export const createConnectedAccount = functions.https.onCall(async (data, context) => {
  const userId = context.auth.uid;
  
  // Stripe Express Account erstellen (einfachste Variante)
  const account = await stripe.accounts.create({
    type: 'express',
    country: data.country || 'DE',
    email: data.email,
    capabilities: {
      card_payments: { requested: true },
      transfers: { requested: true },
    },
  });
  
  // Account Link f√ºr Onboarding
  const accountLink = await stripe.accountLinks.create({
    account: account.id,
    refresh_url: 'https://sunriza.app/seller/refresh',
    return_url: 'https://sunriza.app/seller/success',
    type: 'account_onboarding',
  });
  
  // In Firestore speichern
  await admin.firestore().collection('users').doc(userId).update({
    isSeller: true,
    stripeConnectAccountId: account.id,
    stripeConnectStatus: 'pending',
  });
  
  return { url: accountLink.url };
});
```

### Schritt 3: User f√ºllt Stripe-Formular aus
- Stripe zeigt **fertiges Formular** (in User's Sprache)
- User gibt Bankdaten ein
- User best√§tigt Identit√§t (KYC)
- Stripe pr√ºft alles

### Schritt 4: Account aktiviert
- Webhook von Stripe: `account.updated`
- Status in Firestore: `stripeConnectStatus = 'active'`
- User kann jetzt Media verkaufen

---

## üìä DASHBOARD: Verk√§ufer-Statistiken

### Was User sehen sollten
```dart
class SellerDashboard extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // Earnings
        _buildEarningCard(
          'Einnahmen (diesen Monat)',
          '234,50 ‚Ç¨',
        ),
        
        // Pending Payouts
        _buildPayoutCard(
          'N√§chste Auszahlung',
          '127,30 ‚Ç¨',
          'in 3 Tagen',
        ),
        
        // Sales
        _buildSalesCard(
          'Verk√§ufe',
          '47 Bilder, 12 Videos, 8 Audios',
        ),
        
        // Stripe Dashboard Link
        ElevatedButton(
          onPressed: () => _openStripeDashboard(),
          child: Text('Zu Stripe Dashboard'),
        ),
      ],
    );
  }
}
```

---

## üîí SICHERHEIT & COMPLIANCE

### Was Stripe Connect automatisch macht
‚úÖ **KYC/AML** - Identity Verification  
‚úÖ **Steuer-Compliance** - 1099/W-2 Forms (US), Steuer-IDs  
‚úÖ **Fraud-Detection** - Betrugs-Pr√§vention  
‚úÖ **Chargebacks** - R√ºckbuchungen  
‚úÖ **Payouts** - Automatische Auszahlungen  
‚úÖ **Multi-Currency** - Internationale Zahlungen  

### Was IHR machen m√ºsst
‚ö†Ô∏è **AGB** - Marketplace-Bedingungen  
‚ö†Ô∏è **Impressum** - Platform-Betreiber  
‚ö†Ô∏è **Datenschutz** - DSGVO-konform  
‚ö†Ô∏è **Content-Moderation** - Illegale Inhalte blockieren  

---

## üí° CREDITS + STRIPE CONNECT

### Hybrid-Modell (Beste L√∂sung)

#### K√§ufer-Seite: Credits (wie bisher)
```
K√§ufer kauft Credits mit Stripe
Credits = bequeme Zahlung, keine Geb√ºhren pro Kauf
```

#### Verk√§ufer-Seite: Echtes Geld (Stripe Connect)
```
Verk√§ufer bekommt echtes Geld auf Bankkonto
KEINE Credits f√ºr Verk√§ufer
```

#### Wie Credits zu Geld werden
```
1. K√§ufer zahlt 15 Credits f√ºr Bild (= 1,50 ‚Ç¨)
2. Cloud Function:
   - Zieht 15 Credits vom K√§ufer ab
   - Erstellt Transfer zu Verk√§ufer-Account
   - Verk√§ufer bekommt 1,43 ‚Ç¨ (nach eurer Provision)
3. Stripe zahlt automatisch an Verk√§ufer aus
```

**Code:**
```typescript
// Credits zu Geld
export const purchaseMediaWithCredits = functions.https.onCall(async (data, context) => {
  const buyerId = context.auth.uid;
  const { mediaId, credits } = data;
  
  // Media laden
  const media = await getMedia(mediaId);
  const sellerId = media.ownerId;
  const sellerAccount = await getSellerAccount(sellerId);
  
  // Credits abziehen
  await deductCredits(buyerId, credits);
  
  // Geld an Verk√§ufer transferieren
  const amountInCents = credits * 10; // 1 Credit = 0,10 ‚Ç¨
  const platformFee = Math.round(amountInCents * 0.20); // 20% Provision
  
  await stripe.transfers.create({
    amount: amountInCents - platformFee,
    currency: 'eur',
    destination: sellerAccount.stripeConnectAccountId,
    metadata: {
      mediaId,
      buyerId,
      sellerId,
    },
  });
  
  // Transaktion speichern
  await saveTransaction({ ... });
  
  return { success: true };
});
```

---

## üéØ FINALE L√ñSUNG (ABGESTIMMT)

### ‚úÖ Hybrid-Modell: Credits + Stripe Connect

**K√§ufer-Seite:**
- Kaufen Credits (z.B. 25‚Ç¨ = 250 Credits)
- Zahlen Media mit Credits (bequem, keine Fee pro Kauf)
- Credits gelten 12 Monate

**Verk√§ufer-Seite:**
- Erhalten echtes Geld via Stripe Connect
- Monatliche Sammel-Auszahlung (nur 1x Stripe-Fee)
- Keine Credits f√ºr Verk√§ufer

**Platform (IHR):**
- Behaltet 20% Provision (Standard, individuell anpassbar)
- Zahlt Ende Monat gesammelt aus
- Habt Liquidit√§t aus Credits-Verk√§ufen

#### Vorteile
1. **Rechtlich sauber** - Verk√§ufer ist Verk√§ufer
2. **Steuerlich korrekt** - Jeder versteuert selbst
3. **Automatische Auszahlungen** - Stripe macht das
4. **Keine E-Geld-Lizenz** n√∂tig
5. **Skalierbar** - International ohne Probleme
6. **Best UX** - K√§ufer: Credits, Verk√§ufer: Echtes Geld

#### Nachteile
- Etwas komplexer zu implementieren
- Verk√§ufer m√ºssen Identit√§t verifizieren (KYC)
- Stripe nimmt ~2-3% von Verk√§ufer-Einnahmen

---

## üìã N√ÑCHSTE SCHRITTE

### Phase 1: UserProfile erweitern
- [ ] Seller-Felder hinzuf√ºgen
- [ ] Business-Daten optional
- [ ] Firestore Migration

### Phase 2: Stripe Connect Integration
- [ ] `createConnectedAccount` Function
- [ ] Onboarding-Flow UI
- [ ] Webhook f√ºr `account.updated`
- [ ] Seller Dashboard

### Phase 3: Payout-System
- [ ] Credits ‚Üí Transfer Logic
- [ ] Direktkauf ‚Üí Split Payment
- [ ] Transaction History f√ºr Verk√§ufer
- [ ] Payout Notifications

### Phase 4: Compliance
- [ ] AGB/Marketplace Terms
- [ ] Seller Agreement
- [ ] Content Moderation
- [ ] Tax Forms Integration

---

## üí∞ CASHFLOW-BEISPIEL

### Monat 1
```
10 K√§ufer kaufen je 25‚Ç¨ Credits
‚Üí IHR habt: 250‚Ç¨ cash auf Stripe

50 Media-K√§ufe f√ºr gesamt 50‚Ç¨ (in Credits)
‚Üí K√§ufer-Credits: -500 Credits
‚Üí Verk√§ufer-Guthaben: +50‚Ç¨

Monatsende: Auszahlung
‚Üí IHR zahlt: 40‚Ç¨ (50‚Ç¨ - 20% Provision)
‚Üí IHR behaltet: 210‚Ç¨
```

**Keine Vorfinanzierung n√∂tig** - Credits-Einnahmen decken Auszahlungen!

---

## üìã IMPLEMENTIERUNGS-PLAN

### Phase 1: UserProfile erweitern ‚úÖ BEREIT
- [x] Seller-Felder
- [x] Business-Daten
- [x] Stripe Connect Account ID

### Phase 2: Stripe Connect Onboarding
- [ ] Cloud Function: `createConnectedAccount`
- [ ] Onboarding UI Flow
- [ ] Webhook: `account.updated`
- [ ] KYC-Status Tracking

### Phase 3: Monatliche Payouts
- [ ] Cloud Scheduler (1x/Monat)
- [ ] Credits ‚Üí Euro Umrechnung
- [ ] Stripe Transfers an Verk√§ufer
- [ ] Payout Notifications

### Phase 4: Seller Dashboard
- [ ] Earnings Overview
- [ ] Sales History
- [ ] Payout Schedule
- [ ] Stripe Dashboard Link

---

**LOS GEHT'S!** üöÄ

